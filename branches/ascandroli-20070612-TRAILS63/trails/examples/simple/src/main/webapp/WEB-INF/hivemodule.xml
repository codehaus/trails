<?xml version="1.0"?>
<module id="trails" version="1.0.0">

	<contribution configuration-id="tapestry.state.ApplicationObjects">
		<state-object name="callbackStack" scope="session">
			<create-instance class="org.trails.callback.CallbackStack"/>
		</state-object>
	</contribution>

	<implementation service-id="trails.core.DefaultDescriptorService">
		<invoke-factory service-id="hivemind.lib.SpringLookupFactory">
			<lookup-bean name="descriptorService"/>
		</invoke-factory>
	</implementation>

	<implementation service-id="trails.core.DefaultPersistenceService">
		<invoke-factory service-id="hivemind.lib.SpringLookupFactory">
			<lookup-bean name="persistenceService"/>
		</invoke-factory>
	</implementation>

	<service-point id="LocaleHolder" interface="org.apache.tapestry.services.WebRequestServicerFilter">
		<invoke-factory>
			<construct class="org.trails.i18n.LocaleFilter">
				<set-object property="threadLocale" value="service:hivemind.ThreadLocale"/>
				<set-object property="localeHolder" value="spring:localeHolder"/>
			</construct>
		</invoke-factory>
	</service-point>

	<service-point id="RefererFilter" interface="org.apache.tapestry.services.WebRequestServicerFilter">
		<invoke-factory>
			<construct class="org.trails.i18n.RefererFilter"/>
		</invoke-factory>
	</service-point>

	<contribution configuration-id="tapestry.request.WebRequestServicerPipeline">
		<filter name="LocaleHolder" object="service:LocaleHolder"/>
		<filter name="RefererFilter" object="service:RefererFilter"/>
	</contribution>

	<contribution configuration-id="tapestry.url.ServiceEncoders">
		<page-service-encoder id="page" extension="page" service="page"/>
		<encoder id="edit" before="external"
				 object="instance:org.trails.io.EntityEncoder,pageName='DefaultEdit',url='/entities',prefix='HIBRN8:Dorg.trails.demo.'"/>
		<encoder id="list" before="external"
				 object="instance:org.trails.io.EntityEncoder,pageName='DefaultList',url='/lists',prefix='Dorg.trails.demo.'"/>

		<page-service-encoder id="external" extension="external" service="external"/>
		<direct-service-encoder id="direct" stateless-extension="direct" stateful-extension="sdirect"/>
		<asset-encoder id="asset" path="/assets"/>
		<extension-encoder id="extension" extension="svc" after="*"/>
	</contribution>


	<implementation service-id="tapestry.persist.PersistentPropertyDataEncoder">
		<invoke-factory>
			<construct class="org.trails.io.SqueezerDataEncoder">
				<set-object property="dataSqueezer" value="service:tapestry.data.DataSqueezer"/>
			</construct>
		</invoke-factory>
	</implementation>

</module>