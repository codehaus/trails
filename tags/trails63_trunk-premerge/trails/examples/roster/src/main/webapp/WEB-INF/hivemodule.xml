<?xml version="1.0"?>
<module id="trails" version="1.0.0">

	<contribution configuration-id="tapestry.state.ApplicationObjects">
		<state-object name="callbackStack" scope="session">
			<create-instance class="org.trails.callback.CallbackStack"/>
		</state-object>
		<state-object name="currentUser" scope="session">
			<invoke-factory object="service:currentUserFactory"/>
		</state-object>
	</contribution>

	<implementation service-id="trails.core.DescriptorService">
		<invoke-factory service-id="hivemind.lib.SpringLookupFactory">
			<lookup-bean name="descriptorService"/>
		</invoke-factory>
	</implementation>

	<implementation service-id="trails.core.PersistenceService">
		<invoke-factory service-id="hivemind.lib.SpringLookupFactory">
			<lookup-bean name="persistenceService"/>
		</invoke-factory>
	</implementation>

	<implementation service-id="trails.hibernate.PersistenceService">
		<invoke-factory service-id="hivemind.lib.SpringLookupFactory">
			<lookup-bean name="persistenceService"/>
		</invoke-factory>
	</implementation>

	<implementation service-id="trails.core.EditorService">
		<invoke-factory service-id="hivemind.lib.SpringLookupFactory">
			<lookup-bean name="editorService"/>
		</invoke-factory>
	</implementation>

	<implementation service-id="trails.core.ViewerService">
		<invoke-factory service-id="hivemind.lib.SpringLookupFactory">
			<lookup-bean name="viewerService"/>
		</invoke-factory>
	</implementation>

	<service-point id="currentUserFactory" interface="org.apache.tapestry.engine.state.StateObjectFactory">
		<invoke-factory>
			<construct class="org.trails.demo.service.CurrentUserFactory">
				<set-object property="webRequest" value="service:tapestry.globals.WebRequest"/>
				<set-object property="userDao" value="spring:trailsUserDAO"/>
			</construct>
		</invoke-factory>
	</service-point>

	<implementation service-id="trails.core.MessageSource">
		<invoke-factory service-id="hivemind.lib.SpringLookupFactory">
			<lookup-bean name="trailsMessageSource"/>
		</invoke-factory>
	</implementation>

	<contribution configuration-id="tapestry.url.ServiceEncoders">
		<page-service-encoder id="page" extension="page" service="page"/>
		<direct-service-encoder id="direct" stateless-extension="direct" stateful-extension="sdirect"/>
		<asset-encoder id="asset" path="/assets"/>
		<extension-encoder id="extension" extension="svc" after="*"/>
	</contribution>

	<contribution configuration-id="tapestry.InfrastructureOverrides">
		<property name="exceptionPresenter" object="service:trails.core.ApplicationExceptionPresenter"/>
		<property name="exceptionPageName" value="DefaultException"/>
	</contribution>

</module>